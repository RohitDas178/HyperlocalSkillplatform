<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skilloc - Hyperlocal Marketplace</title>
    <link rel="stylesheet" href="dash.css">
    <!-- Leaflet CSS for local maps -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        #mapContainer {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>SKILLOC</h1>
            <p>Find Skilled Local Professionals in Your Region</p>
        </header>

        <!-- Main Dashboard -->
        <main class="main-content">
            <!-- Login Section Container -->
            <div class="login-container">
                
                <!-- Worker Login Section -->
                <div class="login-section worker-section">
                    <div class="section-title">
                        <h2>Login as Worker</h2>
                        <p>Offer your skills and services</p>
                    </div>
                    <form class="login-form">
                        <div class="form-group">
                            <label for="worker-email">Email Address</label>
                            <input type="email" id="worker-email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="worker-password">Password</label>
                            <input type="password" id="worker-password" name="password" placeholder="Enter your password" required>
                        </div>
                        <div class="form-group">
                            <label for="worker-profession">Profession</label>
                            <select id="worker-profession" name="profession" required>
                                <option value="">Select your profession</option>
                                <option value="electrician">Electrician</option>
                                <option value="plumber">Plumber</option>
                                <option value="mechanic">Mechanic</option>
                                <option value="carpenter">Carpenter</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="worker-location">Your Location</label>
                            <input type="text" id="worker-location" name="location" placeholder="Enter your region/city" required>
                        </div>
                        <button type="submit" class="btn-login">Login as Worker</button>
                    </form>
                    <p class="signup-link">Don't have an account? <a href="worker.html">Register here</a></p>
                </div>

                <!-- Client Login Section -->
                <div class="login-section client-section">
                    <div class="section-title">
                        <h2>Login as Client</h2>
                        <p>Find skilled professionals near you</p>
                    </div>
                    <form class="login-form">
                        <div class="form-group">
                            <label for="client-email">Email Address</label>
                            <input type="email" id="client-email" name="email" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group">
                            <label for="client-password">Password</label>
                            <input type="password" id="client-password" name="password" placeholder="Enter your password" required>
                        </div>
                        <div class="form-group">
                            <label for="client-service">Service Needed</label>
                            <select id="client-service" name="service" required>
                                <option value="">Select a service</option>
                                <option value="electrical">Electrical Work</option>
                                <option value="plumbing">Plumbing</option>
                                <option value="automotive">Automotive Repair</option>
                                <option value="carpentry">Carpentry</option>
                                <option value="other">Other Service</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="client-location">Your Location</label>
                            <input type="text" id="client-location" name="location" placeholder="Enter your region/city" required>
                        </div>
                        <button type="submit" class="btn-login">Login as Client</button>
                    </form>
                    <p class="signup-link">Don't have an account? <a href="client.html">Register here</a></p>
                </div>

            </div>

            <!-- Services Display Section -->
            <section class="services-section">
                <h2>Available Services Near You</h2>
                <div class="services-grid">
                    <div class="service-card">
                        <div class="service-icon">âš¡</div>
                        <h3>Electricians</h3>
                        <p>Professional electrical services for residential and commercial needs</p>
                        <button class="btn-browse" data-category="electrician">Browse</button>
                    </div>
                    <div class="service-card">
                        <div class="service-icon">ðŸ”§</div>
                        <h3>Plumbers</h3>
                        <p>Expert plumbing solutions for all your water and drainage issues</p>
                        <button class="btn-browse" data-category="plumber">Browse</button>
                    </div>
                    <div class="service-card">
                        <div class="service-icon">ðŸ”©</div>
                        <h3>Mechanics</h3>
                        <p>Skilled automotive mechanics for vehicle repairs and maintenance</p>
                        <button class="btn-browse" data-category="mechanic">Browse</button>
                    </div>
                    <div class="service-card">
                        <div class="service-icon">ðŸª›</div>
                        <h3>Carpenters</h3>
                        <p>Professional carpentry services for construction and furniture work</p>
                        <button class="btn-browse" data-category="carpenter">Browse</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Skilloc - Hyperlocal Marketplace. All rights reserved.</p>
        </footer>
    </div>
    <!-- Nearby results modal -->
    <div id="nearbyModal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0f1724;color:#e6eef8;padding:20px;border-radius:8px;z-index:2000;max-width:90%;width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,0.6);">
        <h3 id="modalTitle">Nearby</h3>
        <div id="mapContainer" style="display:none;"></div>
        <div id="modalBody" style="margin-top:10px;max-height:300px;overflow:auto"></div>
        <div style="margin-top:12px;text-align:right">
            <button id="openLocalMapBtn" style="margin-right:8px;padding:8px 12px;background:#ff2fa6;color:#fff;border:none;border-radius:6px;display:none;">Open Local Map</button>
            <button id="closeModal" style="padding:8px 12px;background:#444;color:#fff;border:none;border-radius:6px;">Close</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
    (function(){
        const thresholdMeters = 5; // maximum distance to consider (in meters)
        let mapInstance = null;

        function haversineMeters(lat1, lon1, lat2, lon2){
            const R = 6371000; // meters
            const toRad = v => v * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function initializeMap(lat, lng, workers) {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.display = 'block';
            
            // Reset map if it exists
            if (mapInstance) {
                mapInstance.remove();
            }
            
            // Initialize Leaflet map with OpenStreetMap
            mapInstance = L.map('mapContainer').setView([lat, lng], 16);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(mapInstance);
            
            // Add marker for user location
            L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: '#FF6B6B',
                color: '#FF6B6B',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.8
            }).addTo(mapInstance).bindPopup('Your Location');
            
            // Add markers for workers
            workers.forEach(w => {
                L.circleMarker([w.latitude, w.longitude], {
                    radius: 6,
                    fillColor: '#4ECDC4',
                    color: '#4ECDC4',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.8
                }).addTo(mapInstance).bindPopup(
                    `<strong>${w.firstName} ${w.lastName || ''}</strong><br>
                     Profession: ${w.profession}<br>
                     Phone: ${w.phone || 'N/A'}`
                );
            });
            
            // Fit bounds to show all markers
            if (workers.length > 0) {
                const bounds = L.latLngBounds([[lat, lng]], [[lat, lng]]);
                workers.forEach(w => bounds.extend([w.latitude, w.longitude]));
                mapInstance.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function showModal(title, html, lat, lng, workers){
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = html;
            const modal = document.getElementById('nearbyModal');
            modal.style.display = 'block';
            
            // Initialize map if we have location data
            if (lat !== undefined && lng !== undefined && workers.length > 0) {
                document.getElementById('openLocalMapBtn').style.display = 'inline-block';
                // Initialize map after modal is displayed
                setTimeout(() => {
                    initializeMap(lat, lng, workers);
                }, 100);
            } else {
                document.getElementById('mapContainer').style.display = 'none';
                document.getElementById('openLocalMapBtn').style.display = 'none';
            }
            
            document.getElementById('closeModal').onclick = () => { 
                modal.style.display = 'none';
                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }
            };
        }

        async function findNearby(category){
            if (!navigator.geolocation) return alert('Geolocation is not supported by your browser');
            navigator.geolocation.getCurrentPosition(async (pos)=>{
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                try{
                    const res = await fetch('/api/nearby', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category, lat, lng })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Server error');

                    const workers = data.workers || [];
                    if (workers.length === 0) {
                        showModal('No nearby workers found', `<p>No registered ${category} found within ${thresholdMeters} meters.</p><p>Try searching in a different location.</p>`, lat, lng, []);
                        return;
                    }

                    // Build result list
                    const listHtml = workers.map(w=>{
                        const d = haversineMeters(lat, lng, w.latitude, w.longitude);
                        return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.05)"><strong>${w.firstName} ${w.lastName || ''}</strong><div style="font-size:13px;color:#bcd">${(d).toFixed(1)} m away</div><div style="margin-top:6px;font-size:12px;color:#aaa">ðŸ“ž ${w.phone || 'N/A'}</div></div>`;
                    }).join('');

                    showModal(`${workers.length} result(s) near you`, listHtml, lat, lng, workers);
                }catch(err){
                    console.error(err);
                    alert(err.message || 'Error searching nearby');
                }
            }, (err)=>{
                alert('Unable to retrieve your location: ' + (err.message||err.code));
            }, { enableHighAccuracy: false, maximumAge: 30000, timeout: 10000 });
        }

        document.querySelectorAll('.btn-browse').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                const category = btn.getAttribute('data-category') || btn.closest('.service-card')?.querySelector('h3')?.textContent?.toLowerCase() || 'service';
                findNearby(category);
            });
        });
    })();
    </script>
</body>
</html>

    <!-- Task Creation Modal -->
    <div id="taskModal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0f1724;color:#e6eef8;padding:25px;border-radius:8px;z-index:3000;max-width:90%;width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 40px rgba(0,0,0,0.8);">
        <h3 style="margin-bottom:15px;color:#fff;border-bottom:2px solid #ff2fa6;padding-bottom:10px;">Create Task for Worker</h3>
        <form id="taskForm" style="display:flex;flex-direction:column;gap:12px;">
            <input type="hidden" id="taskWorkerId">
            <input type="hidden" id="taskWorkerName">
            <input type="hidden" id="taskWorkerPhone">
            <input type="hidden" id="taskProfession">
            
            <div style="background:#1a2a3a;padding:10px;border-radius:6px;">
                <strong id="taskWorkerDisplay">Worker: Loading...</strong>
            </div>
            
            <div>
                <label style="font-weight:600;color:#e6eef8;display:block;margin-bottom:5px;">Description of Work *</label>
                <textarea id="taskDescription" required placeholder="Describe the work you need done..." style="width:100%;padding:10px;border:2px solid #81c784;border-radius:6px;background:#fff;color:#000;font-family:inherit;resize:vertical;min-height:80px;"></textarea>
            </div>
            
            <div>
                <label style="font-weight:600;color:#e6eef8;display:block;margin-bottom:5px;">Location</label>
                <input type="text" id="taskLocation" placeholder="Work location (optional)" style="width:100%;padding:10px;border:2px solid #81c784;border-radius:6px;background:#fff;color:#000;font-family:inherit;">
            </div>
            
            <div>
                <label style="font-weight:600;color:#e6eef8;display:block;margin-bottom:5px;">Service Date</label>
                <input type="date" id="taskServiceDate" style="width:100%;padding:10px;border:2px solid #81c784;border-radius:6px;background:#fff;color:#000;font-family:inherit;">
            </div>
            
            <div>
                <label style="font-weight:600;color:#e6eef8;display:block;margin-bottom:5px;">Budget (Optional)</label>
                <input type="number" id="taskBudget" placeholder="Budget in your currency" style="width:100%;padding:10px;border:2px solid #81c784;border-radius:6px;background:#fff;color:#000;font-family:inherit;">
            </div>
            
            <div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end;">
                <button type="button" id="cancelTaskBtn" style="padding:10px 20px;background:#444;color:#fff;border:none;border-radius:6px;cursor:pointer;">Cancel</button>
                <button type="submit" style="padding:10px 20px;background:#ff2fa6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Create Task</button>
            </div>
        </form>
    </div>
